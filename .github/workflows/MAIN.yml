# GitHub Action for generating a contribution graph with a snake eating your contributions.
name: Generate Snake

# Controls when the action will run.
on:
  schedule:
    # Runs every 12 hours
    - cron: "0 */12 * * *"

  # Allows manual run from Actions tab
  workflow_dispatch:
  
  # Runs on every push to main branch
  push:
    branches:
      - main

# The sequence of runs in this workflow:
jobs:
  build:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
    
      - name: Generate snake animation
        uses: Platane/snk@v3
        id: snake-gif
        with:
          github_user_name: ${{ github.repository_owner }}
          outputs: |
            dist/github-contribution-grid-snake.svg
            dist/github-contribution-grid-snake-dark.svg?palette=github-dark
            dist/github-contribution-grid-snake.gif?color_snake=orange&color_dots=#bfd6f6,#8dbdff,#64a1f4,#4b91f1,#3c7dd9
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Checkout or create output branch
        run: |
          if git ls-remote --heads origin output | grep -q output; then
            echo "Output branch exists, checking out..."
            git fetch origin output
            git checkout -b output origin/output 2>/dev/null || git checkout output
          else
            echo "Creating output branch..."
            git checkout --orphan output
            git rm -rf . 2>/dev/null || true
            # Create initial commit for orphan branch
            echo "# Snake animation output" > README.md
            git add README.md
            git commit -m "Initialize output branch"
          fi

      - name: Copy files to output branch
        run: |
          # Remove all files except .git
          find . -mindepth 1 -maxdepth 1 ! -name '.git' -exec rm -rf {} + 2>/dev/null || true
          # Copy generated files from dist
          cp dist/github-contribution-grid-snake.svg . 2>/dev/null || true
          cp dist/github-contribution-grid-snake-dark.svg . 2>/dev/null || true
          cp dist/github-contribution-grid-snake.gif . 2>/dev/null || true
          # List files to verify
          ls -la

      - name: Commit and push
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update snake animations [skip ci]"
            git push origin output --force
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
